# Copyright 2014 The Chromium Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import("//build/config/android/config.gni")
import("//build/config/arm.gni")
import("//build/config/compiler/compiler.gni")
import("//build/config/sanitizers/sanitizers.gni")
import("//third_party/boringssl/src/gen/sources.gni")

# Config for us and everybody else depending on BoringSSL.
config("external_config") {
  include_dirs = [ "//third_party/boringssl/src/include" ]
  if (is_component_build) {
    defines = [ "BORINGSSL_SHARED_LIBRARY" ]
  }
}

# The config used by the :boringssl component itself, and the fuzzer copies.
config("component_config") {
  visibility = [ ":*" ]
  configs = [ ":internal_config" ]
  defines = [ "BORINGSSL_IMPLEMENTATION" ]
}

# This config is used by anything that consumes internal headers. Tests consume
# this rather than :component_config.
config("internal_config") {
  visibility = [ ":*" ]
  defines = [ "OPENSSL_SMALL" ]
}

config("no_asm_config") {
  visibility = [ ":*" ]
  defines = [ "OPENSSL_NO_ASM" ]
}

# TODO(crbug.com/42290535): Move Chromium's use of libpki to the public API and
# unexport pki_internal_headers.
all_sources = bcm_internal_headers + bcm_sources + crypto_internal_headers +
              crypto_sources + ssl_internal_headers + ssl_sources + pki_sources
all_headers = crypto_headers + ssl_headers + pki_headers + pki_internal_headers

all_sources += [
  "//third_party/boringssl/src/decrepit/evp/evp_do_all.cc",
  "//third_party/boringssl/src/decrepit/xts/xts.cc",
]

all_sources += [
  "//third_party/boringssl/src/decrepit/blowfish/blowfish.cc",
  "//third_party/boringssl/src/decrepit/cfb/cfb.cc",
  "//third_party/boringssl/src/decrepit/ripemd/internal.h",
  "//third_party/boringssl/src/decrepit/ripemd/ripemd.cc",
]

if (is_msan) {
  # MSan instrumentation is incompatible with assembly optimizations.
  # BoringSSL's GAS-compatible assembly knows how to detect MSan, but the NASM
  # assembly does not, so we check for MSan explicitly.
  source_set("boringssl_asm") {
    visibility = [ ":*" ]
    public_configs = [ ":no_asm_config" ]
  }
  source_set("test_support_asm") {
    visibility = [ ":*" ]
    testonly = true
  }
} else if (is_win && (current_cpu == "x86" || current_cpu == "x64")) {
  # Windows' x86 and x86_64 assembly is built with NASM.
  import("//third_party/nasm/nasm_assemble.gni")
  nasm_assemble("boringssl_asm") {
    visibility = [ ":*" ]
    sources = rebase_path(bcm_sources_nasm + crypto_sources_nasm, "//third_party/boringssl", "//third_party/boringssl/src")
  }
  nasm_assemble("test_support_asm") {
    visibility = [ ":*" ]
    sources = rebase_path(test_support_sources_nasm, "//third_party/boringssl", "//third_party/boringssl/src")
  }
} else {
  # All other targets use GAS-compatible assembler. BoringSSL's assembly files
  # are all wrapped in processor checks for the corresponding target, so there
  # is no need to add target conditions in the build.
  source_set("boringssl_asm") {
    visibility = [ ":*" ]
    sources = rebase_path(bcm_sources_asm + crypto_sources_asm, "//third_party/boringssl", "//third_party/boringssl/src")
    include_dirs = [ "//third_party/boringssl/src/include" ]
  }
  source_set("test_support_asm") {
    visibility = [ ":*" ]
    sources = rebase_path(test_support_sources_asm, "//third_party/boringssl", "//third_party/boringssl/src")
    include_dirs = [ "//third_party/boringssl/src/include" ]
  }
}

component("boringssl") {
  sources = rebase_path(all_sources, "//third_party/boringssl", "//third_party/boringssl/src")
  public = rebase_path(all_headers, "//third_party/boringssl", "//third_party/boringssl/src")
  friend = [ ":*" ]
  deps = [ "//third_party/boringssl/src/third_party/fiat:fiat_license" ]

  # Mark boringssl_asm as a public dependency so the OPENSSL_NO_ASM
  # config is forwarded to callers. In particular, boringssl_crypto_tests
  # requires it.
  public_deps = [ ":boringssl_asm" ]

  public_configs = [ ":external_config" ]
  configs += [ ":component_config" ]

  configs -= [ "//build/config/compiler:chromium_code" ]
  configs += [ "//build/config/compiler:no_chromium_code" ]

  if (!is_debug && !(is_fuchsia && optimize_for_size)) {
    configs -= [ "//build/config/compiler:default_optimization" ]
    configs += [ "//build/config/compiler:optimize_max" ]
  }

  if (is_linux && is_component_build) {
    version_script = "boringssl.map"
    inputs = [ version_script ]
    ldflags = [ "-Wl,--version-script=" +
                rebase_path(version_script, root_build_dir) ]
  }
}
